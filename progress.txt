## Codebase Patterns
- Package is at src/qptifffile/, uses src layout
- Install with `pip install -e .` to work in editable mode
- No mypy configured; use `python -c "import ..."` for typecheck verification
- All public symbols exported from src/qptifffile/__init__.py
- QPTIFF root XML tag: "PerkinElmer-QPI-ImageDescription"; tifffile flag: is_qpi=True
- OME-TIFF root XML tag: "OME" (with namespace); tifffile flag: is_ome=True; has XML comment prefix that must be stripped before parsing
- OME-TIFF namespace: "http://www.openmicroscopy.org/Schemas/OME/2016-06"
- OME-TIFF channels found via .//ome:Channel with Name attribute containing channel name
- QPTIFF Biomarker field: .//Biomarker; fluorophore from first .//Name element
- Package-data config goes in pyproject.toml [tool.setuptools.package-data] section

---

## 2026-02-26 - US-007
- What was implemented: Created `src/qptifffile/mxtifffile.py` (copy of qptifffile.py with class renamed to MxTiffFile); QPTiffFile defined as subclass in __init__.py with DeprecationWarning
- Files changed: src/qptifffile/mxtifffile.py (created), src/qptifffile/__init__.py (updated)
- **Learnings for future iterations:**
  - MxTiffFile is now the primary class in mxtifffile.py; qptifffile.py still exists unchanged
  - QPTiffFile is defined in __init__.py (not mxtifffile.py) as a subclass wrapper
---

## 2026-02-26 - US-009
- What was implemented: US-009 was already satisfied by work done in US-008 (`formats_config` param) and US-003 (`load_formats(path)` with FileNotFoundError). Verified all acceptance criteria pass.
- Files changed: prd.json (pass mark), progress.txt
- **Learnings for future iterations:**
  - When wiring a new feature param, verify that downstream stories may already be covered
---

## 2026-02-26 - US-008
- What was implemented: Replaced `_extract_biomarkers()` with `_detect_and_parse()` in MxTiffFile; added `formats_config` param; `format_id` attribute set on success
- Files changed: src/qptifffile/mxtifffile.py
- **Learnings for future iterations:**
  - `_detect_and_parse()` uses lazy imports to avoid circular import issues
  - `formats_config=None` uses bundled formats.json; pass path string for custom config
  - biomarkers/fluorophores lists derived from channel_info; None values preserved
  - MxTiffFormatError raised with informative message including root tag and ANCHOR_MARKER hint
---

## 2026-02-26 - US-006
- What was implemented: Created `src/qptifffile/heuristic.py` with `ANCHOR_MARKER='DAPI'`, `heuristic_detect()`, `_per_page_heuristic()`, `_file_level_heuristic()`
- Files changed: src/qptifffile/heuristic.py (created), src/qptifffile/__init__.py (updated)
- **Learnings for future iterations:**
  - Circular import avoided by putting `import qptifffile as _pkg` inside function bodies (lazy import)
  - Helper functions that need the ANCHOR_MARKER should take it as a parameter to avoid circular imports
  - Heuristic finds element tag where ANCHOR_MARKER appears, then uses that tag for all pages
  - `qptifffile.ANCHOR_MARKER` can be modified by users at module level; heuristic reads it via lazy import
---

## 2026-02-26 - US-005
- What was implemented: Created `src/qptifffile/parsers.py` with `PerPageParser`, `FileLevelParser`, `ImageJParser` classes
- Files changed: src/qptifffile/parsers.py (created)
- **Learnings for future iterations:**
  - PerPageParser: biomarker uses list of XPaths (first match wins); fluorophore uses single XPath
  - FileLevelParser: strips XML comments, uses ns_map for ome: namespace in XPath; attribute lookup before child text
  - ImageJParser: splits Labels by newline; handles list/string/None
  - All parsers return list[dict] with keys: index, biomarker, fluorophore, display_name, description, exposure, wavelength, raw_xml
---

## 2026-02-26 - US-004
- What was implemented: Created `src/qptifffile/format_detector.py` with `detect_format()` function; strips OME XML comments before parsing; OME-TIFF prioritized over ImageJ
- Files changed: src/qptifffile/format_detector.py (created), src/qptifffile/__init__.py (updated)
- **Learnings for future iterations:**
  - OME-TIFF files have XML comment wrapper; must use `_OME_COMMENT_RE.sub()` before ET.fromstring()
  - Root tag has namespace: `{http://...}OME` — strip namespace for comparison
  - is_qpi=True for QPTIFF, is_ome=True for OME-TIFF; both match their respective root tags
  - Ordering ome-tiff before imagej handles hybrid Bio-Formats files
---

## 2026-02-26 - US-003
- What was implemented: Created `src/qptifffile/format_config.py` with `FormatConfig` and `FormatDetection` dataclasses, `load_formats()` function with caching and importlib.resources support
- Files changed: src/qptifffile/format_config.py (created), src/qptifffile/__init__.py (updated)
- **Learnings for future iterations:**
  - Python 3.9+ uses `importlib.resources.files()` API; 3.8 uses `read_text()` — added both fallbacks
  - Cache is module-level `_CACHE` variable; only caches for path=None (bundled)
  - `FormatDetection` is a nested dataclass for the detection sub-object
---

## 2026-02-26 - US-002
- What was implemented: Created `src/qptifffile/formats.json` with format entries for qptiff, ome-tiff, and imagej; added package-data entry in pyproject.toml
- Files changed: src/qptifffile/formats.json (created), pyproject.toml (updated)
- **Learnings for future iterations:**
  - QPTIFF: is_qpi=True, root tag="PerkinElmer-QPI-ImageDescription", Biomarker element holds biomarker name, first Name element holds fluorophore
  - OME-TIFF: is_ome=True, root tag="OME" (namespaced), channels in .//ome:Channel with Name attribute; has comment wrapper
  - OME-TIFF only uses Name attribute for both biomarker and fluorophore (no separate element)
  - Package-data for non-Python files goes in pyproject.toml [tool.setuptools.package-data]
---

## 2026-02-26 - US-001
- What was implemented: Created `src/qptifffile/exceptions.py` with `MxTiffFormatError(Exception)` class; exported from `__init__.py`
- Files changed: src/qptifffile/exceptions.py (created), src/qptifffile/__init__.py (updated)
- **Learnings for future iterations:**
  - Project uses `src/` layout — package root is `src/qptifffile/`
  - No mypy in environment; typecheck verified via `python -c "from qptifffile import ..."` import test
  - `__init__.py` currently only imports from `qptifffile.py`; each new module needs explicit export added
---
