## Codebase Patterns
- Package is at src/mxtifffile/, uses src layout (renamed from src/qptifffile/)
- Install with `pip install -e .` to work in editable mode
- No mypy configured; typecheck verified via `python -c "import ..."` import tests
- All public symbols exported from src/mxtifffile/__init__.py
- QPTIFF root XML tag: "PerkinElmer-QPI-ImageDescription"; tifffile flag: is_qpi=True
- OME-TIFF root XML tag: "OME" (with namespace); tifffile flag: is_ome=True; has XML comment prefix that must be stripped before parsing
- OME-TIFF namespace: "http://www.openmicroscopy.org/Schemas/OME/2016-06"
- OME-TIFF channels found via .//ome:Channel with Name attribute containing channel name
- QPTIFF Biomarker field: .//Biomarker; fluorophore from first .//Name element
- Package-data config goes in pyproject.toml [tool.setuptools.package-data]
- QPTiffFile is a subclass wrapper in __init__.py that emits DeprecationWarning
- MxTiffFile._detect_and_parse() uses lazy imports to avoid circular import issues
- load_formats() cache is module-level _CACHE; call load_formats.cache_clear() in tests for custom paths
- Real test data: test_data/A-1.ome.tif, test_data/Roche_Fusion_TonsilandIntestine_1.qptiff, test_data/Untitled.ome.tif
- setuptools>=80 requires [project] table in pyproject.toml; metadata fully migrated there (setup.cfg kept in sync but pyproject.toml is authoritative)
- pytest.ini_options goes in pyproject.toml [tool.pytest.ini_options]
- dev extras defined in both pyproject.toml [project.optional-dependencies] and setup.cfg [options.extras_require]

---

## 2026-02-26 - US-002 through US-014
- US-002: Fixed python-publish.yml environment.url from qptifffile to mxtifffile; added trusted publishing note
- US-003: Updated meta.yaml name, version, source URL, sha256 comment, home, summary, test imports
- US-004: Created .github/workflows/update-conda-recipe.yml that fetches PyPI SHA256 and opens PR
- US-005: Created RELEASE.md with full release checklist including conda-forge submission
- US-006: Created tests/__init__.py, tests/conftest.py with fixtures; added pytest config to pyproject.toml
- US-007: Fixed format_config.py (qptifffile→mxtifffile); added cache_clear; 6 tests passing
- US-008: Created tests/test_format_detector.py; 7 tests passing
- US-009: Fixed FileLevelParser to propagate ET.ParseError; 5 tests passing
- US-010: Fixed heuristic.py (removed qptifffile imports); 3 tests passing
- US-011: Fixed mxtifffile.py (qptifffile→mxtifffile reference); 6 integration tests passing
- US-012: 4 error handling tests passing
- US-013: 4 QPTiffFile backward compat tests passing
- US-014: Created .github/workflows/tests.yml CI workflow
- Total: 35 tests, 0 failures
- **Learnings for future iterations:**
  - Multiple source files had "import qptifffile" or files("qptifffile") hardcoded - always search for old package name after rename
  - heuristic.py used "import qptifffile as _pkg" for ANCHOR_MARKER but it's defined locally - simplified to direct reference
  - FileLevelParser silently returned [] on malformed XML; changed to propagate ET.ParseError
  - MagicMock().series can't use list.__getitem__ assignment; set series = [] directly for empty series
  - pytest --collect-only returns exit code 5 (no tests) which is not an error; the infra works
---

## 2026-02-26 - US-001
- Renamed src/qptifffile/ directory to src/mxtifffile/ using git mv
- Updated setup.cfg: name = mxtifffile, description updated to multiplex TIFF description
- Migrated project metadata to pyproject.toml [project] table (setuptools>=80 requires it)
- Updated [tool.setuptools.package-data] key from qptifffile to mxtifffile
- Added dev extras (pytest, pytest-cov) in both setup.cfg and pyproject.toml
- Files changed: setup.cfg, pyproject.toml, src/mxtifffile/ (renamed directory)
- **Learnings for future iterations:**
  - setuptools>=80 requires [project] table in pyproject.toml; otherwise install fails with "project must contain version properties"
  - When renaming a package directory, use `git mv src/old src/new` to preserve git history
  - The old src/qptifffile.egg-info is now stale; mxtifffile.egg-info is generated on reinstall
  - pyproject.toml [project] section is now the authoritative metadata source; setup.cfg [metadata] is kept in sync
---
