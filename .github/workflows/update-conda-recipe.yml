name: Update Conda Recipe

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-meta-yaml:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get release version
        id: get-version
        run: echo "version=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"

      - name: Fetch SHA256 from PyPI
        id: get-sha256
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          SHA256=$(curl -s "https://pypi.org/pypi/mxtifffile/${VERSION}/json" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for f in data['urls']:
              if f['packagetype'] == 'sdist':
                  print(f['digests']['sha256'])
                  break
          ")
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Update meta.yaml version and sha256
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          SHA256="${{ steps.get-sha256.outputs.sha256 }}"
          sed -i "s/{% set version = \".*\" %}/{% set version = \"${VERSION}\" %}/" meta.yaml
          sed -i "s/sha256: .*/sha256: ${SHA256}/" meta.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update conda recipe to ${{ steps.get-version.outputs.version }}"
          title: "chore: update conda recipe to ${{ steps.get-version.outputs.version }}"
          body: |
            Automated update of `meta.yaml` for release `${{ steps.get-version.outputs.version }}`.

            - Version updated to `${{ steps.get-version.outputs.version }}`
            - SHA256 hash fetched from PyPI and updated

            After merging, submit this updated `meta.yaml` to conda-forge/staged-recipes if this is the first release.
          branch: "chore/update-conda-recipe-${{ steps.get-version.outputs.version }}"
          base: main
